<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Restablecer contraseña</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <h2>Restablecer contraseña</h2>

    <div>
      <input
        id="password"
        type="password"
        placeholder="Nueva contraseña"
        autocomplete="new-password"
      />
    </div>
    <div style="margin-top: 8px">
      <button id="btn-reset">Cambiar contraseña</button>
    </div>

    <p id="msg" style="margin-top: 12px; color: red;"></p>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const supabaseUrl = "https://axggbupenrrsqjhjhnbg.supabase.co";
      const supabaseAnonKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4Z2didXBlbnJyc3FqaGpobmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NjQwMDIsImV4cCI6MjA4MjM0MDAwMn0.M7q025ebZiiN7Jcd-5TBKdU60VFVBmkU3Ge6peAuJP4";

      const supabase = createClient(supabaseUrl, supabaseAnonKey);

      const msgEl = document.getElementById("msg");
      const btn = document.getElementById("btn-reset");

      function getAccessTokenFromHash() {
        const hash = window.location.hash.startsWith("#")
          ? window.location.hash.slice(1)
          : window.location.hash;
        const params = new URLSearchParams(hash);
        return params.get("access_token");
      }

      btn.addEventListener("click", async () => {
        msgEl.style.color = "red";
        msgEl.textContent = "";

        const newPassword = document.getElementById("password").value.trim();
        if (!newPassword) {
          msgEl.textContent = "Introduce una nueva contraseña.";
          return;
        }

        const accessToken = getAccessTokenFromHash();
        if (!accessToken) {
          msgEl.textContent =
            "Token no encontrado en la URL. Abre esta página desde el enlace del email.";
          return;
        }

        const { data, error } = await supabase.auth.updateUser(
          { password: newPassword },
          { accessToken }
        );

        if (error) {
          msgEl.textContent = "Error: " + error.message;
          return;
        }

        msgEl.style.color = "green";
        msgEl.textContent = "Contraseña cambiada correctamente. Ya puedes iniciar sesión.";
      });
    </script>
  </body>
</html>

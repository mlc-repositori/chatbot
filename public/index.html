<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Virtual English Tutor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #F8D763;
      margin: 0;
      padding: 20px;
      font-size: clamp(16px, 2.8vw, 20px);
    }

    .chatbot-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
    }

    .chatbot-container img {
      width: 100%;
      max-width: 250px;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .chatbot-container h3 {
      font-size: clamp(18px, 3.4vw, 24px);
      margin: 0 0 10px 0;
    }

    button {
      font-size: clamp(16px, 3vw, 20px);
      padding: 10px 16px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    p {
      margin: 6px 0;
    }

    #userText, #botText {
      display: inline-block;
      background: white;
      padding: 6px 10px;
      border-radius: 6px;
      max-width: 90%;
    }
  </style>
</head>

<body>

<div class="chatbot-container">
  <img id="avatar" src="avatarprofemujer2.jpg" alt="Avatar">

  <div>
    <h3>Virtual English Tutor</h3>

    <button id="startBtn">ðŸŽ¤ Speak</button>

    <p><strong>You:</strong> <span id="userText"></span></p>
    <p><strong>Teacher:</strong> <span id="botText"></span></p>

    <p id="timeRow" style="display:none;">
      <strong>Time remaining:</strong> <span id="timeSpent"></span>
    </p>
  </div>
</div>

<script>
/* ----------------------------------------------------------
   CONFIG
----------------------------------------------------------- */
const API_BASE = "https://chatbot-xzhi.onrender.com";

const avatar = document.getElementById("avatar");
const userText = document.getElementById("userText");
const botText = document.getElementById("botText");
const timeSpent = document.getElementById("timeSpent");
const timeRow = document.getElementById("timeRow");

/* ----------------------------------------------------------
   LOGS DE DEPURACIÃ“N
----------------------------------------------------------- */
console.log(">>> HTML cargado correctamente");

/* ----------------------------------------------------------
   HISTORIAL LOCAL
----------------------------------------------------------- */
function getTodayKey() {
  return "history_" + new Date().toISOString().split("T")[0];
}

function saveHistory(userMsg, botMsg) {
  const key = getTodayKey();
  let h = JSON.parse(localStorage.getItem(key) || "[]");

  h.push({ user: userMsg, bot: botMsg });
  if (h.length > 5) h = h.slice(-5);

  localStorage.setItem(key, JSON.stringify(h));
}

function loadLastHistory() {
  const key = getTodayKey();
  const h = JSON.parse(localStorage.getItem(key) || "[]");
  if (h.length > 0) {
    const last = h[h.length - 1];
    userText.textContent = last.user;
    botText.textContent = last.bot;
  }
}

/* ----------------------------------------------------------
   FORMATEAR TIEMPO
----------------------------------------------------------- */
function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

/* ----------------------------------------------------------
   BOTÃ“N HABLAR â€” TU FLUJO ORIGINAL + LOGS
----------------------------------------------------------- */
document.getElementById("startBtn").onclick = async () => {
  console.log(">>> CLICK en Speak");
  userText.textContent = "(Listening...)";

  try {
    console.log(">>> Pidiendo permiso al micro...");
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    console.log(">>> Permiso concedido, stream OK:", stream);

    let mimeType = null;
    if (MediaRecorder.isTypeSupported("audio/webm")) mimeType = "audio/webm";
    else if (MediaRecorder.isTypeSupported("audio/mp4")) mimeType = "audio/mp4";

    console.log(">>> MIME elegido:", mimeType);

    const recorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
    const chunks = [];

    recorder.onstart = () => console.log(">>> recorder STARTED");
    recorder.onstop = () => console.log(">>> recorder STOPPED");
    recorder.onerror = e => console.error(">>> recorder ERROR:", e);

    recorder.ondataavailable = e => {
      console.log(">>> DATA AVAILABLE:", e.data.size);
      chunks.push(e.data);
    };

    console.log(">>> Estado antes de start:", recorder.state);
    recorder.start();
    console.log(">>> recorder.start() ejecutado");

    setTimeout(() => {
      console.log(">>> Ejecutando recorder.stop()");
      recorder.stop();
    }, 3000);

    recorder.onstop = async () => {
      console.log(">>> STOP recibido, chunks:", chunks);

      const blob = new Blob(chunks, { type: mimeType || "audio/webm" });
      console.log(">>> Blob final tamaÃ±o:", blob.size);

      const formData = new FormData();
      formData.append("audio", blob, "audio");

      console.log(">>> Enviando a /stt...");
      const sttRes = await fetch(API_BASE + "/stt", {
        method: "POST",
        body: formData
      });

      const sttData = await sttRes.json();
      console.log(">>> Respuesta /stt:", sttData);

      const transcript = sttData.text || "";
      userText.textContent = transcript;

      sendToChatbot(transcript);
    };

  } catch (err) {
    console.error(">>> ERROR en grabaciÃ³n:", err);
    userText.textContent = "Microphone error";
  }
};

/* ----------------------------------------------------------
   ENVIAR TEXTO AL CHATBOT â€” LOGS AÃ‘ADIDOS
----------------------------------------------------------- */
async function sendToChatbot(message) {
  console.log(">>> Enviando mensaje al chatbot:", message);

  const key = getTodayKey();
  const fullHistory = JSON.parse(localStorage.getItem(key) || "[]");
  const last3 = fullHistory.slice(-3);

  const res = await fetch(API_BASE + "/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      message,
      history: last3,
      firstname: "Student",
      lastname: "",
      userId: "browser_user",
      email: null
    })
  });

  const data = await res.json();
  console.log(">>> Respuesta /chat:", data);

  const reply = data.reply || "Error";
  botText.textContent = reply;

  saveHistory(message, reply);

  const remaining = Math.max(300 - (data.timeSpentToday || 0), 0);
  timeSpent.textContent = formatTime(remaining);
  timeRow.style.display = "block";

  playAudio(reply, data.audio);
}

/* ----------------------------------------------------------
   REPRODUCIR AUDIO TTS â€” LOGS AÃ‘ADIDOS
----------------------------------------------------------- */
function playAudio(text, base64Audio) {
  console.log(">>> Reproduciendo TTS, tamaÃ±o base64:", base64Audio?.length);

  if (!base64Audio) return;

  const audio = new Audio("data:audio/mp3;base64," + base64Audio);

  audio.onplay = () => {
    console.log(">>> TTS PLAY");
    avatar.src = "teachergif2.gif";
  };

  audio.onended = () => {
    console.log(">>> TTS END");
    avatar.src = "avatarprofemujer2.jpg";

    fetch(API_BASE + "/ttsTime", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: "browser_user",
        seconds: audio.duration
      })
    })
    .then(r => r.json())
    .then(d => {
      console.log(">>> Respuesta /ttsTime:", d);
      const remaining = Math.max(300 - d.total, 0);
      timeSpent.textContent = formatTime(remaining);
    });
  };

  audio.play();
}

/* ----------------------------------------------------------
   SALUDO INICIAL
----------------------------------------------------------- */
window.addEventListener("load", () => {
  console.log(">>> PÃ¡gina cargada, iniciando saludo");

  const todayKey = getTodayKey();
  const last = JSON.parse(localStorage.getItem(todayKey) || "[]");

  if (last.length > 0) {
    loadLastHistory();
  } else {
    const now = new Date();
    const dateStr = now.toLocaleDateString("en-US", {
      weekday: "long",
      month: "long",
      day: "numeric"
    });

    const greeting = `Hello! I'm your virtual English tutor. Welcome to today's practice, ${dateStr}.`;
    botText.textContent = greeting;

    saveHistory("", greeting);
  }
});
</script>

</body>
</html>

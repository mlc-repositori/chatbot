<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chatbot con Avatar Animado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #F8D763;
      font-size: clamp(16px, 2.8vw, 20px);
      margin: 0;
      padding: 20px;
    }
    .chatbot-container {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 20px;
    }
    .chatbot-container img {
      display: block;
      width: 100%;
      max-width: 250px;
      height: auto;
      margin: 0 auto;
    }
    .chatbot-container h3 {
      font-size: clamp(18px, 3.4vw, 24px);
      margin: 0 0 10px 0;
    }
    .chatbot-container button {
      font-size: clamp(16px, 3vw, 20px);
      padding: 8px 12px;
      margin-bottom: 10px;
    }
    .chatbot-container p {
      font-size: clamp(16px, 2.8vw, 20px);
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div class="chatbot-container">
    <img id="avatar" src="avatarprofemujer2.jpg" alt="Avatar">
    <div>
      <h3>Chatbot de voz en inglÃ©s</h3>

      <!-- FIX: NO disabled en el HTML -->
      <button id="unlockBtn" style="display:none;">ðŸ”Š Activar sonido</button>
      <button id="startBtn">ðŸŽ¤ Hablar</button>

      <p><strong>TÃº:</strong> <span id="userText"></span></p>
      <p><strong>Bot:</strong> <span id="botText"></span></p>

      <p><strong>Voz seleccionada:</strong> <span id="voiceName">(cargando voces...)</span></p>

      <p id="timeRow" style="display:none;"><strong>Tiempo restante:</strong> <span id="timeSpent"></span></p>
    </div>
  </div>

<script>
/* ----------------------------------------------------------
   DETECTAR IPHONE
----------------------------------------------------------- */
const isIphone = /iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ----------------------------------------------------------
   FIX: NO disabled en HTML â†’ deshabilitar solo con JS
----------------------------------------------------------- */
window.addEventListener("DOMContentLoaded", () => {
  if (isIphone) {
    unlockBtn.style.display = "inline-block";
    unlockBtn.disabled = false;
    startBtn.disabled = true;
  } else {
    unlockBtn.style.display = "none";
    startBtn.disabled = false;
  }
});

/* ----------------------------------------------------------
   ESPERAR VOCES
----------------------------------------------------------- */
function waitForVoices() {
  return new Promise(resolve => {
    let voices = speechSynthesis.getVoices();
    if (voices.length > 0) return resolve(voices);
    speechSynthesis.onvoiceschanged = () => resolve(speechSynthesis.getVoices());
  });
}

let selectedVoice = null;

async function chooseBestVoice() {
  if (!isIphone) {
    const voices = speechSynthesis.getVoices();
    selectedVoice = voices.find(v => v.lang.startsWith("en-"));
    voiceName.textContent = selectedVoice ? selectedVoice.name : "Default";
    startBtn.disabled = false;
    return;
  }

  const voices = await waitForVoices();

  function setVoice(v) {
    selectedVoice = v;
    voiceName.textContent = v ? v.name : "(sin voces)";
    unlockBtn.disabled = false;
  }

  let v = voices.find(v => v.name.toLowerCase().includes("allison"));
  if (v) return setVoice(v);

  v = voices.find(v => v.name.toLowerCase().includes("samantha"));
  if (v) return setVoice(v);

  v = voices.find(v => v.lang === "en-GB");
  if (v) return setVoice(v);

  v = voices.find(v => v.lang.startsWith("en-"));
  if (v) return setVoice(v);

  setVoice(null);
}

/* ----------------------------------------------------------
   DUMMY SPEAK (iPhone)
----------------------------------------------------------- */
if (isIphone) {
  window.addEventListener("load", () => {
    const dummy = new SpeechSynthesisUtterance(" ");
    dummy.volume = 0;
    speechSynthesis.speak(dummy);
    setTimeout(() => chooseBestVoice(), 150);
  });
}

/* ----------------------------------------------------------
   DESBLOQUEO DE AUDIO (iPhone)
----------------------------------------------------------- */
let audioUnlocked = false;

function unlockAudio() {
  if (!isIphone || audioUnlocked) return;

  const silent = new Audio();
  silent.src = "data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA...";
  silent.play().catch(()=>{});

  audioUnlocked = true;

  startBtn.disabled = false;
  unlockBtn.disabled = true;
  unlockBtn.textContent = "Sonido activado";

  const lastBotMessage = botText.textContent.trim();
  if (lastBotMessage) setTimeout(() => speakWithAvatar(lastBotMessage), 150);
}

unlockBtn.onclick = unlockAudio;

/* ----------------------------------------------------------
   VARIABLES
----------------------------------------------------------- */
let mediaRecorder = null;
let audioChunks = [];
let mediaStream = null;
let audioContext = null;
let ttsContext = null; // ðŸ”¥ CONTEXTO PERSISTENTE PARA TTS

const userText = document.getElementById("userText");
const botText = document.getElementById("botText");
const timeSpent = document.getElementById("timeSpent");
const timeRow = document.getElementById("timeRow");
const avatar = document.getElementById("avatar");

/* ----------------------------------------------------------
   HISTORIAL
----------------------------------------------------------- */
function getTodayDate() {
  return new Date().toISOString().split("T")[0];
}
function getHistoryKey() {
  return "chatHistory_" + getTodayDate();
}
function saveHistory(userMsg, botMsg) {
  const key = getHistoryKey();
  let h = JSON.parse(localStorage.getItem(key) || "[]");
  h.push({ user: userMsg, bot: botMsg });
  if (h.length > 5) h = h.slice(-5);
  localStorage.setItem(key, JSON.stringify(h));
}
function loadLastMessage() {
  const h = JSON.parse(localStorage.getItem(getHistoryKey()) || "[]");
  if (h.length > 0) {
    userText.textContent = h[h.length - 1].user;
    botText.textContent = h[h.length - 1].bot;
  }
}

/* ----------------------------------------------------------
   FORMATEAR TIEMPO
----------------------------------------------------------- */
function formatTime(seconds) {
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

/* ----------------------------------------------------------
   BOTÃ“N HABLAR â€” ADAPTADO AL NUEVO BACKEND
----------------------------------------------------------- */
startBtn.onclick = async () => {

  if (!mediaStream) {
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  }

  mediaRecorder = new MediaRecorder(mediaStream);
  audioChunks = [];

  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

  mediaRecorder.onstop = async () => {
    userText.textContent = "";

    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
    const formData = new FormData();
    formData.append("audio", audioBlob, "audio.webm");

    // STT
    const sttRes = await fetch("https://chatbot-xzhi.onrender.com/stt", {
      method: "POST",
      body: formData
    });
    const sttData = await sttRes.json();
    const transcript = sttData.text || "";
    userText.textContent = transcript;

    // Historial
    const fullHistory = JSON.parse(localStorage.getItem(getHistoryKey()) || "[]");
    const last3 = fullHistory.slice(-3);

    // CHAT
    const chatRes = await fetch("https://chatbot-xzhi.onrender.com/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: moodleUserId,
        firstname: moodleFirstname,
        lastname: moodleLastname,
        email: null,
        message: transcript,
        history: last3
      })
    });

    const data = await chatRes.json();
    const response = data.reply || "Error";
    botText.textContent = response;

    saveHistory(transcript, response);

    const remaining = Math.max(300 - (data.timeSpentToday || 0), 0);
    timeSpent.textContent = formatTime(remaining);
    timeRow.style.display = "block";

    // TTS backend o fallback
    if (data.audio) {
      playBackendTTS(response, data.audio);
    } else {
      speakWithAvatar(response);
    }
  };

  // DetecciÃ³n de silencio
  audioContext = new AudioContext();
  const source = audioContext.createMediaStreamSource(mediaStream);
  const analyser = audioContext.createAnalyser();
  analyser.fftSize = 2048;
  source.connect(analyser);

  let silenceStart = Date.now();
  const SILENCE_THRESHOLD = 0.01;
  const SILENCE_DURATION = 1500;

  function checkSilence() {
    const data = new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(data);

    let sum = 0;
    for (let i = 0; i < data.length; i++) {
      const v = (data[i] - 128) / 128;
      sum += v * v;
    }
    const rms = Math.sqrt(sum / data.length);

    if (rms < SILENCE_THRESHOLD) {
      if (Date.now() - silenceStart > SILENCE_DURATION) {
        mediaRecorder.stop();
        return;
      }
    } else {
      silenceStart = Date.now();
    }

    requestAnimationFrame(checkSilence);
  }

  mediaRecorder.start();
  userText.textContent = "(Escuchando...)";
  checkSilence();
};

/* ----------------------------------------------------------
   TTS BACKEND â€” WebAudio (FUNCIONA EN IPHONE)
----------------------------------------------------------- */
async function playBackendTTS(text, base64Audio) {
  try {
    if (!ttsContext) {
      ttsContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (ttsContext.state === "suspended") {
      await ttsContext.resume();
    }

    const arrayBuffer = Uint8Array.from(atob(base64Audio), c => c.charCodeAt(0)).buffer;
    const audioBuffer = await ttsContext.decodeAudioData(arrayBuffer);

    const source = ttsContext.createBufferSource();
    source.buffer = audioBuffer;
    source.connect(ttsContext.destination);

    avatar.src = "teachergif2.gif";

    const ttsStart = Date.now();

    source.onended = () => {
      const ttsDuration = (Date.now() - ttsStart) / 1000;
      avatar.src = "avatarprofemujer2.jpg";

      fetch("https://chatbot-xzhi.onrender.com/ttsTime", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: moodleUserId,
          seconds: ttsDuration
        })
      })
      .then(r => r.json())
      .then(d => {
        const remaining = Math.max(300 - d.total, 0);
        timeSpent.textContent = formatTime(remaining);
      });
    };

    source.start(0);

  } catch (err) {
    console.warn("Fallo TTS backend, usando fallback:", err);
    speakWithAvatar(text);
  }
}

/* ----------------------------------------------------------
   TTS LOCAL (fallback)
----------------------------------------------------------- */
function speakWithAvatar(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  if (selectedVoice) utterance.voice = selectedVoice;
  else utterance.lang = "en-US";

  let ttsStart = 0;

  utterance.onstart = () => {
    ttsStart = Date.now();
    avatar.src = "teachergif2.gif";
  };

  utterance.onend = () => {
    const ttsDuration = (Date.now() - ttsStart) / 1000;
    avatar.src = "avatarprofemujer2.jpg";

    fetch("https://chatbot-xzhi.onrender.com/ttsTime", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        userId: moodleUserId,
        seconds: ttsDuration
      })
    })
    .then(r => r.json())
    .then(d => {
      const remaining = Math.max(300 - d.total, 0);
      timeSpent.textContent = formatTime(remaining);
    });
  };

  speechSynthesis.speak(utterance);
}

/* ----------------------------------------------------------
   SALUDO INICIAL
----------------------------------------------------------- */
window.addEventListener("load", () => {
  chooseBestVoice();

  const today = getTodayDate();
  const lastDate = localStorage.getItem("lastConnectionDate");

  if (lastDate === today) {
    loadLastMessage();
  } else {
    const now = new Date();
    const formattedDate = now.toLocaleDateString("en-US", {
      weekday: "long", year: "numeric", month: "long", day: "numeric"
    });

    const greeting = `Hello! I'm your virtual teacher Brenda. Welcome to today's English practice, ${formattedDate}.`;
    botText.textContent = greeting;
    saveHistory("", greeting);
  }

  if (!isIphone) {
    const lastBotMessage = botText.textContent.trim();
    if (lastBotMessage) setTimeout(() => speakWithAvatar(lastBotMessage), 150);
  }

  localStorage.setItem("lastConnectionDate", today);
});
</script>

</body>
</html>
